---
- name: install RKE2 prerequisites
  apt:
    name:
      - curl
      - apparmor-utils
      - iptables
      - ca-certificates
    state: latest
    cache_valid_time: 86400
  tags:
    - rke2
    - rke_packages

- name: create RKE2 config dir
  file:
    path: /etc/rancher/rke2
    state: directory
  tags:
    - rke2
    - rke2_config_dir

- name: configure RKE2 tls-san
  ansible.builtin.template:
    src: "config.j2"
    dest: "/etc/rancher/rke2/config.yaml"
  tags:
    - rke2
    - tls-san

- name: configure PATH to kubectl in .bashrc
  lineinfile: dest="/root/.bashrc"
              regexp="^PATH=/var/lib/rancher/rke2/bin:"
              line="PATH=/var/lib/rancher/rke2/bin:$PATH"
              state=present
  tags:
    - rke2
    - rke2_kubectl_path
    - rke2_kubectl_path_bashrc

- name: configure path to kubectl in .profile
  lineinfile: dest="/root/.profile"
              regexp="^PATH=/var/lib/rancher/rke2/bin:"
              line="PATH=/var/lib/rancher/rke2/bin:$PATH"
              state=present
              insertbefore="^mesg n 2> /dev/null || true"
  tags:
    - rke2
    - rke2_kubectl_path
    - rke2_kubectl_path_profile

# check_mode return changed in check mode, it was fixed in
# Ansible 2.13.0, https://github.com/ansible/ansible/issues/65687
- name: download rke2 installer
  ansible.builtin.get_url:
    url: https://get.rke2.io
    dest: /usr/local/bin/rke2-install.sh
    mode: '0755'
    backup: true

# versions of rke2 are listed here:
#    https://github.com/ansible/ansible/issues/65687
# but we are OK with any present
- name: exec rke2 installer
  ansible.builtin.shell:
    cmd: /usr/local/bin/rke2-install.sh
    creates: /usr/local/bin/rke2

- name: enable & start rke service
  ansible.builtin.systemd:
    name: rke2-server.service
    enabled: yes
    masked: no
    state: started

# this and later command is needed to kubectl start working
- name: create kube config dir
  file:
    path: /root/.kube
    state: directory
  tags:
    - rke2
    - kube_config
    - kube_config_dir

- name: copy kube config
  ansible.builtin.copy:
    src: /etc/rancher/rke2/rke2.yaml
    dest: /root/.kube/config
    owner: root
    group: root
    mode: '0600'

- name: install helm prerequisites
  apt:
    name:
      - apt-transport-https
      - gpg
    state: latest
    update_cache: no
    cache_valid_time: 86400
  tags:
    - rke2
    - rke_packages
    - helm
    - heml_packages

- name: install heml keyring
  ansible.builtin.get_url:
    url: https://baltocdn.com/helm/signing.asc
    dest: /usr/share/keyrings/helm.asc
    mode: 0644
  tags:
    - rke2
    - rke_packages
    - helm
    - heml_packages

- name: add heml packages repository
  ansible.builtin.apt_repository:
    repo: deb [signed-by=/usr/share/keyrings/helm.asc] https://baltocdn.com/helm/stable/debian/ all main
    state: present
  tags:
    - rke2
    - rke_packages
    - heml_packages
    - helm

- name: install helm
  apt:
    name: helm
    state: latest
    cache_valid_time: 86400
  when: not ansible_check_mode # will fail in check mode if db isn't present
  tags:
    - rke2
    - rke_packages
    - helm
    - heml_packages
